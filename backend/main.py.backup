from fastapi import FastAPI, Depends, HTTPException, status, UploadFile, File, Form
from fastapi.middleware.cors import CORSMiddleware
from typing import List, Optional
from app.models import *
from app.utils.auth import get_current_user, get_current_active_user
from app.services.auth_service import AuthService
from app.services.processo_service import ProcessoService
from app.services.documento_service import DocumentoService
from app.database import get_supabase_admin

# Criar app FastAPI
app = FastAPI(
    title="Sistema de Gest칚o de Processos - CBB",
    description="API para gest칚o de processos eletr칪nicos da Confedera칞칚o Brasileira de Basketball",
    version="1.0.0"
)

# Configurar CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Em produ칞칚o, especificar dom칤nios permitidos
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Instanciar servi칞os
auth_service = AuthService()
processo_service = ProcessoService()
documento_service = DocumentoService()

# ==================== ROTAS DE AUTENTICA칂츾O ====================

@app.post("/api/auth/login", response_model=Token, tags=["Autentica칞칚o"])
async def login(login_data: LoginRequest):
    """Autentica usu치rio e retorna token JWT"""
    return await auth_service.login(login_data)

@app.post("/api/auth/register", response_model=UsuarioResponse, tags=["Autentica칞칚o"])
async def register(usuario: UsuarioCreate):
    """Registra novo usu치rio"""
    return await auth_service.register(usuario.model_dump())

@app.get("/api/auth/me", response_model=UsuarioResponse, tags=["Autentica칞칚o"])
async def get_me(current_user: UsuarioResponse = Depends(get_current_active_user)):
    """Retorna dados do usu치rio autenticado"""
    return current_user

# ==================== ROTAS DE PROCESSOS ====================

@app.post("/api/processos", response_model=ProcessoResponse, tags=["Processos"])
async def criar_processo(
    processo: ProcessoCreate,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Cria um novo processo"""
    return await processo_service.criar_processo(processo, current_user.id)

@app.get("/api/processos/{processo_id}", response_model=ProcessoResponse, tags=["Processos"])
async def buscar_processo(
    processo_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Busca processo por ID"""
    return await processo_service.buscar_processo(processo_id)

@app.get("/api/processos/protocolo/{numero_protocolo}", response_model=ProcessoResponse, tags=["Processos"])
async def buscar_por_protocolo(
    numero_protocolo: str,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Busca processo por n칰mero de protocolo"""
    return await processo_service.buscar_por_protocolo(numero_protocolo)

@app.get("/api/processos", response_model=List[ProcessoResponse], tags=["Processos"])
async def listar_processos(
    numero_protocolo: Optional[str] = None,
    assunto: Optional[str] = None,
    interessado: Optional[str] = None,
    tipo_processo_id: Optional[int] = None,
    status: Optional[StatusProcesso] = None,
    setor_atual_id: Optional[int] = None,
    limit: int = 20,
    offset: int = 0,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Lista processos com filtros"""
    filtros = ProcessoFiltros(
        numero_protocolo=numero_protocolo,
        assunto=assunto,
        interessado=interessado,
        tipo_processo_id=tipo_processo_id,
        status=status,
        setor_atual_id=setor_atual_id
    )
    processos, total = await processo_service.listar_processos(filtros, limit=limit, offset=offset)
    return processos

@app.get("/api/processos/meus/lista", response_model=List[ProcessoResponse], tags=["Processos"])
async def listar_meus_processos(
    limit: int = 20,
    offset: int = 0,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Lista processos criados pelo usu치rio atual"""
    processos, total = await processo_service.listar_processos(
        usuario_id=current_user.id,
        limit=limit,
        offset=offset
    )
    return processos

@app.get("/api/processos/setor/{setor_id}", response_model=List[ProcessoResponse], tags=["Processos"])
async def listar_processos_setor(
    setor_id: int,
    limit: int = 20,
    offset: int = 0,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Lista processos de um setor"""
    processos, total = await processo_service.listar_processos(
        setor_id=setor_id,
        limit=limit,
        offset=offset
    )
    return processos

@app.put("/api/processos/{processo_id}", response_model=ProcessoResponse, tags=["Processos"])
async def atualizar_processo(
    processo_id: int,
    processo: ProcessoUpdate,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Atualiza processo"""
    return await processo_service.atualizar_processo(processo_id, processo, current_user.id)

@app.post("/api/processos/{processo_id}/tramitar", response_model=TramitacaoResponse, tags=["Processos"])
async def tramitar_processo(
    print(f"游댌 DEBUG - Dados recebidos: {tramitacao_data}")
    
    processo_id: int,
    tramitacao: TramitacaoCreate,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Tramita processo para outro setor"""
    if tramitacao.processo_id != processo_id:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="ID do processo n칚o corresponde"
        )
    return await processo_service.tramitar_processo(tramitacao, current_user.id)

@app.get("/api/processos/{processo_id}/tramitacoes", response_model=List[TramitacaoResponse], tags=["Processos"])
async def listar_tramitacoes(
    processo_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Lista hist칩rico de tramita칞칫es de um processo"""
    return await processo_service.listar_tramitacoes(processo_id)

@app.post("/api/processos/{processo_id}/concluir", response_model=ProcessoResponse, tags=["Processos"])
async def concluir_processo(
    processo_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Conclui um processo"""
    return await processo_service.concluir_processo(processo_id, current_user.id)

@app.post("/api/processos/{processo_id}/reabrir", response_model=ProcessoResponse, tags=["Processos"])
async def reabrir_processo(
    processo_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Reabre um processo conclu칤do"""
    return await processo_service.reabrir_processo(processo_id, current_user.id)

@app.post("/api/processos/{processo_id}/bloquear", response_model=ProcessoResponse, tags=["Processos"])
async def bloquear_processo(
    processo_id: int,
    motivo: str = Form(...),
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Bloqueia um processo"""
    return await processo_service.bloquear_processo(processo_id, motivo, current_user.id)

@app.post("/api/processos/{processo_id}/desbloquear", response_model=ProcessoResponse, tags=["Processos"])
async def desbloquear_processo(
    processo_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Desbloqueia um processo"""
    return await processo_service.desbloquear_processo(processo_id, current_user.id)

# ==================== ROTAS DE DOCUMENTOS ====================

@app.post("/api/documentos", response_model=DocumentoResponse, tags=["Documentos"])
async def criar_documento(
    documento: DocumentoCreate,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Cria um novo documento"""
    return await documento_service.criar_documento(documento, current_user.id)

@app.post("/api/documentos/upload", response_model=DocumentoResponse, tags=["Documentos"])
async def upload_documento(
    processo_id: int = Form(...),
    arquivo: UploadFile = File(...),
    tipo_documento: str = Form("anexo"),
    nome: Optional[str] = Form(None),
    descricao: Optional[str] = Form(None),
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Faz upload de um arquivo como documento"""
    return await documento_service.upload_documento(
        processo_id=processo_id,
        arquivo=arquivo,
        usuario_id=current_user.id,
        tipo_documento=tipo_documento,
        nome=nome,
        descricao=descricao
    )

@app.get("/api/documentos/{documento_id}", response_model=DocumentoResponse, tags=["Documentos"])
async def buscar_documento(
    documento_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Busca documento por ID"""
    return await documento_service.buscar_documento(documento_id)

@app.get("/api/processos/{processo_id}/documentos", response_model=List[DocumentoResponse], tags=["Documentos"])
async def listar_documentos(
    processo_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Lista documentos de um processo"""
    return await documento_service.listar_documentos(processo_id)

@app.put("/api/documentos/{documento_id}", response_model=DocumentoResponse, tags=["Documentos"])
async def atualizar_documento(
    documento_id: int,
    documento: DocumentoUpdate,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Atualiza documento"""
    return await documento_service.atualizar_documento(documento_id, documento, current_user.id)

@app.delete("/api/documentos/{documento_id}", tags=["Documentos"])
async def excluir_documento(
    documento_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Exclui documento"""
    await documento_service.excluir_documento(documento_id, current_user.id)
    return {"message": "Documento exclu칤do com sucesso"}

# ==================== ROTAS DE DASHBOARD ====================

@app.get("/api/dashboard/stats", response_model=DashboardStats, tags=["Dashboard"])
async def get_dashboard_stats(
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Retorna estat칤sticas para o dashboard"""
    return await processo_service.get_dashboard_stats(current_user.id, current_user.setor_id)

# ==================== ROTAS DE SETORES ====================

@app.get("/api/setores", response_model=List[SetorResponse], tags=["Setores"])
async def listar_setores(
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Lista todos os setores ativos"""
    supabase = get_supabase_admin()
    result = supabase.table("setores").select("*").eq("ativo", True).order("nome").execute()
    return [SetorResponse(**s) for s in result.data]

@app.get("/api/setores/{setor_id}", response_model=SetorResponse, tags=["Setores"])
async def buscar_setor(
    setor_id: int,
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Busca setor por ID"""
    supabase = get_supabase_admin()
    result = supabase.table("setores").select("*").eq("id", setor_id).single().execute()
    if not result.data:
        raise HTTPException(status_code=404, detail="Setor n칚o encontrado")
    return SetorResponse(**result.data)

# ==================== ROTAS DE TIPOS DE PROCESSO ====================

@app.get("/api/tipos-processo", response_model=List[TipoProcessoResponse], tags=["Tipos de Processo"])
async def listar_tipos_processo(
    current_user: UsuarioResponse = Depends(get_current_active_user)
):
    """Lista todos os tipos de processo ativos"""
    supabase = get_supabase_admin()
    result = supabase.table("tipos_processo").select("*").eq("ativo", True).order("nome").execute()
    return [TipoProcessoResponse(**tp) for tp in result.data]

# ==================== ROTA DE HEALTH CHECK ====================

@app.get("/health", tags=["Health"])
async def health_check():
    """Verifica se a API est치 rodando"""
    return {"status": "ok", "message": "API rodando"}

@app.get("/", tags=["Root"])
async def root():
    """Rota raiz"""
    return {
        "message": "Sistema de Gest칚o de Processos - CBB API",
        "version": "1.0.0",
        "docs": "/docs"
    }

if __name__ == "__main__":
    import uvicorn
    from app.config import get_settings
    
    settings = get_settings()
    uvicorn.run(
        "main:app",
        host=settings.api_host,
        port=settings.api_port,
        reload=True
    )
